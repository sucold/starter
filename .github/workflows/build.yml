name: Build and Deploy

on: push
jobs:
  build:
    name: Build And Release
    runs-on: ubuntu-latest
    env:
      GOPRIVATE: github.com/hinego,github.com/sucold
      GH_ACCESS_TOKEN: ${{ secrets.ME_SECRET_TOKEN }}
    steps:
      - run: wget -qO /usr/local/bin/dev https://build.skyqq.cc/sucold/dev && chmod 777 /usr/local/bin/dev
      - run: dev
      - name: Checkout Backend Code
        uses: actions/checkout@v3
      - name: Set Up Golang Environment
        uses: actions/setup-go@v2
        with:
          go-version: 1.19.3
      - name: Install Wget
        run: sudo apt-get install wget unzip -y
      - name: Install Goframe
        run: wget -qO gf https://github.com/gogf/gf/releases/latest/download/gf_$(go env GOOS)_$(go env GOARCH) && chmod +x gf && ./gf install -y && rm ./gf
      - name: Download And unzip
        run: wget -qO ui.zip https://build.skyqq.cc/${{github.repository}}-ui.zip
      - run: unzip -o -d public ui.zip
      - run: ls public
      - run: git config --global url.https://$GH_ACCESS_TOKEN@github.com/.insteadOf https://github.com/
      - name: Run Sync
        run: dev sync
      - name: Build Backend
        run: go mod tidy && gf build && ls temp && ls temp/*
        working-directory: ./
      - name: Upload file to R2
        uses: magicwallet/r2-upload@main
        with:
          endpoint: ${{ secrets.R2_ENDPOINT }}
          access_key_id: ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key: ${{ secrets.R2_ACCESS_SECRET_KEY }}
          bucket: ${{ secrets.R2_BUCKET }}
          file: 'temp/linux_amd64/status_linux'
          destination: ${{github.repository}}
