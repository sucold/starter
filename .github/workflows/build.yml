name: Build and Deploy

on: push
jobs:
  build:
    name: Build And Release
    runs-on: ubuntu-latest
    env:
      GOPRIVATE: github.com/hinego,github.com/sucold
      GH_ACCESS_TOKEN: ${{ secrets.ME_SECRET_TOKEN }}
    steps:
      - name: Checkout Backend Code
        uses: actions/checkout@v3
      - name: Checkout Frontend Code
        uses: actions/checkout@v3
        with:
          repository: ${{github.repository}}-ui
          path: 'ui'
          token: ${{ secrets.ME_SECRET_TOKEN }}
      - name: Set Up Golang Environment
        uses: actions/setup-go@v2
        with:
          go-version: 1.19.3
      - uses: actions/setup-node@v3
        with:
          node-version: latest
      - name: Install Wget
        run: sudo apt-get install wget -y
      - name: Install Goframe
        run: wget -O gf https://github.com/gogf/gf/releases/latest/download/gf_$(go env GOOS)_$(go env GOARCH) && chmod +x gf && ./gf install -y && rm ./gf
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Build Frontend
        run: pnpm install && pnpm run build
        working-directory: ./ui
      - name: Copy Frontend File
        run: ls && cp -r dist/* ../public/
        working-directory: ./ui
      - run: git config --global url.https://$GH_ACCESS_TOKEN@github.com/.insteadOf https://github.com/
      - name: Run Sync
        run: go run ./dev sync
        working-directory: ./dev/um
      - name: Build Backend
        run: gf build && ls temp && ls temp/*
        working-directory: ./
      - name: Upload file to R2
        uses: magicwallet/r2-upload@main
        with:
          endpoint: ${{ secrets.R2_ENDPOINT }}
          access_key_id: ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key: ${{ secrets.R2_ACCESS_SECRET_KEY }}
          bucket: ${{ secrets.R2_BUCKET }}
          file: 'temp/linux_amd64/status_linux'
          destination: ${{github.repository}}